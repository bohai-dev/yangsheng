<extend name="$_home_public_layout"/>
<block name="wrap">
    <section class="main">
        <form>
            <ul class="btb bgf last fs14 col3 m-form">
                <li class="table plr10 bb">
                    <label for="" class="table-cell m-form-tit">
                        <span class="col_own">标　　题</span>
                    </label>
                    <div class="table-cell">
                        <input type="text" class="form-unify" name="title" data-value="请填写标题" placeholder="6-30字，不能填写电话">
                    </div>
                </li>
            </ul>

            <ul class="mt10 btb bgf last fs14 col3 m-form">
                <li class="table plr10 bb">
                    <label for="" class="table-cell m-form-tit">
                        <span class="col_own">选择区域</span>
                    </label>
                    <div class="table-cell arrowR">
                        <input type="text"  id="city-picker" class="form-unify" name="area" data-value="请选择区域" placeholder="请选择"  >
                    </div>
                </li>
                <li class="table plr10 bb">
                    <label for="" class="table-cell m-form-tit">
                        <span class="col_own">商铺地址</span>
                    </label>
                    <div class="table-cell">
                        <input type="text" class="form-unify" name="address" data-value="请填写商品地址" placeholder="2-30字，不能填写电话" >
                    </div>
                </li>
            </ul>

            <ul class="mt10 btb bgf last fs14 col3 m-form">
                <li class="table plr10 bb">
                    <label for="" class="table-cell m-form-tit">
                        <span class="col_own">供　　需</span>
                    </label>
                    <div class="table-cell">
                        <div class="clearfix ba radio-options">
                            <label for="rent3" class="opt-label">
                                <input type="radio" class="opt-check" name="type"   value="3" id="rent3"  checked>
                                <span class="opt-checked">转让</span>
                            </label>
                            <label for="rent1" class="opt-label">
                                <input type="radio" class="opt-check" name="type"  value="1" id="rent1">
                                <span class="opt-checked">出租</span>
                            </label>
                            <label for="rent2" class="opt-label">
                                <input type="radio" class="opt-check" name="type"  value="2" id="rent2">
                                <span class="opt-checked">求租</span>
                            </label>
                        </div>
                    </div>
                </li>
                <li class="table plr10 bb">
                    <label for="" class="table-cell m-form-tit">
                        <span class="col_own">租　　金</span>
                    </label>
                    <div class="table-cell">
                        <input type="text" class="form-unify" name="price" data-value="请填写租金" placeholder="数字填写，不能是0" >
                    </div>
                    <div class="table-cell pl10" style="width: 45px;">
                        <span class="col_own">月</span>
                    </div>
                </li>
                <li class="table plr10 bb">
                    <label for="" class="table-cell m-form-tit">
                        <span class="col_own">面　　积</span>
                    </label>
                    <div class="table-cell">
                        <input type="text" class="form-unify" name="acreage" placeholder="数字填写，请输入" >
                    </div>
                    <div class="table-cell pl10" style="width: 45px;">
                        <span class="col_own">平米</span>
                    </div>
                </li>
                <li class="table plr10 bb">
                    <label for="" class="table-cell m-form-tit">
                        <span class="col_own">商铺类型</span>
                    </label>
                    <div class="table-cell arrowR">
                        <input type="text" class="form-unify" name="house_type"  id="house_type" data-value="请填写商铺类型" placeholder="请填写" id="opt-salary" >
                    </div>
                </li>
            </ul>

            <ul class="mt10 btb bgf last fs14 col3 m-form">
                <li class="table plr10 bb">
                    <label for="" class="table-cell vt m-form-tit">
                        <span class="col_own">房源描述</span>
                    </label>
                    <div class="table-cell vt">
                        <textarea name="description" data-value="请输入房源描述" cols="" rows="5" class="form-unify" placeholder="目前经营状态,所在商圈,转让费用..."></textarea>
                    </div>
                </li>
            </ul>

            <ul class="mt10 btb bgf last fs14 col3 m-form">
                <li class="table plr10 bb">
                    <label for="" class="table-cell m-form-tit">
                        <span class="col_own">联系人</span>
                    </label>
                    <div class="table-cell">
                        <input type="text" class="form-unify" name="contacts" data-value="请输入联系人" placeholder="2-4字，只能填写汉字或字母" >
                    </div>
                </li>
                <li class="table plr10 bb">
                    <label for="" class="table-cell m-form-tit">
                        <span class="col_own">联系电话</span>
                    </label>
                    <div class="table-cell">
                        <input type="tel" class="form-unify" name="telephone" data-value="请输入联系方式" placeholder="请输入您的正确联系方式" >
                    </div>
                </li>
            </ul>

            <ul class="clearfix multi-upload">
                <li class="mt10 mr10 bg_own item-hd">
                    <i class=""></i>
                    <p class="tc fs12 colf">添加照片</p>
                </li>
                <li class="mt10 ba br3 upload-file" style="cursor: pointer;">
                    <input type="file" style="visibility: hidden">
                </li>
            </ul>
        </form>
            <div class="btn_submit">
                <button class="bg_own btn-block">免费发布</button>
            </div>


    </section>
</block>
<block name="footer"></block>
<block name="icon"></block>

<block name="script">
    <script type="text/javascript" src="__HTML_WEUI__/js/city-picker.js" charset="utf-8"></script>
    <script>
        // 验证正整数
        function isInteger(number){
            return number > 0 && String(number).split('.')[1] == undefined
        }
        // 上传图片
        function uploadcard(localIds,num) {
            var localId = localIds.pop();
            wx.uploadImage({
                localId: localId, // 需要上传的图片的本地ID，由chooseImage接口获得
                isShowProgressTips: 1, // 默认为1，显示进度提示
                success: function (res) {
                    var serverId = res.serverId; // 返回图片的服务器端ID
                    afterUploadcard(serverId,num);
                },
                fail: function (res) {
                    alert(JSON.stringify(res));
                }
            });
        }

        //上传图片回调
        function afterUploadcard(serverId,num) {
            $.post("{:U('Home/Weixin/download_img')}", {media_id: serverId}, function (data, textStatus, xhr) {
                if (data.status) {
                    $('.upload-file').before('<li class="mt10 mr10 ba br3 upload-img" style="background-image:url(' + data.src + ');"><input type="hidden" name="pics[]" value="' + data.id + '" /><a href="javascript:;" class="br50 upload-close"></a></li>');
                    if (localIds.length > 0) {
                        uploadcard(localIds);
                    }
                } else {
                    $.alert('上传失败，请重新上传资料');
                }
            }, 'json').error(function () {
                $.alert('错误的数据')
            });
        }
       $(function(){
           $("#house_type").picker({
               title: "请选择商铺类型",
               cols: [
                   {
                       textAlign: 'center',
                       values: ['住宅底商', '社区综合', '商业街卖场', '写字楼配套', '其他']
                   }
               ],
               onChange: function(p, v, dv) {
                   console.log(p, v, dv);
               },
               onClose: function(p, v, d) {
                   console.log("close");
               }
           });
           $("#city-picker").cityPicker({
               title: "请选择工作区域"
           });
           wx.config({$jsapi});
           $(document).on('click','.upload-file',function(){
               wx.chooseImage({
                   count: 9, // 默认9
                   sizeType: ['original', 'compressed'], // 可以指定是原图还是压缩图，默认二者都有
                   sourceType: ['album', 'camera'], // 可以指定来源是相册还是相机，默认二者都有
                   success: function (res) {
                       localIds = res.localIds; // 返回选定照片的本地ID列表，localId可以作为img标签的src属性显示图片
                       uploadcard(localIds,0);
                   }
               });
           });
           $(document).on('click','.upload-close',function(){
               $(this).parent('li').remove();
           });
           // 提交表单
           $('.btn-block').on('click',function(){
               var num =0;
               // 验证必填
               $("input[type='text']").each(function(){
                   var error =$(this).attr("data-value");
                   if($(this).val()==''){
                       num ++;
                       $.toptip(error);
                       $(this).focus();
                       return false;
                   }
               });
               if(num >0){
                   return false;
               }
               var number =$("input[name='acreage']").val();
               if(isNaN(number)){
                   $.toptip('面积数据格式填写错误');
                   return false;
               }
               var telephone =$("input[name='telephone']").val();
               if (!telephone.match(/^0?(13|15|18|14|17)[0-9]{9}$/)) {
                   $.alert('请输入正确的手机号！');
                   return false;
               }
               if($("input[name='pics[]']").val()=='' || $("input[name='pics[]']").val()==null){
                   $.toptip('请上传图片');
                   return false;
               }
               $.ajax({
                   url:"{:U('post_rent')}",
                   type:'post',
                   dataType:'json',
                   data:$('form').serialize(),
                   success:function(data){
                       if(data.status){
                           $.alert(data.info,function(){
                               location.href ="{:U('Forum/Rent/index')}";
                           });
                       }else{
                           $.alert(data.info);
                       }
                   },
                   error:function(){

                   }
               });
           });
       })
    </script>
</block>